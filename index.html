<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GST Error Report Converter</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@300;400;500&display=swap');

  :root {
    --bg: #0a0a0f;
    --surface: #12121a;
    --surface2: #1a1a26;
    --border: #2a2a3d;
    --accent: #7c5cfc;
    --accent2: #00e5c8;
    --error: #ff5f6d;
    --text: #e8e8f0;
    --muted: #D3DAE4;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Mono', monospace;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse at 15% 30%, rgba(124,92,252,.07) 0%, transparent 50%),
      radial-gradient(ellipse at 85% 70%, rgba(0,229,200,.05) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
  }

  /* ‚îÄ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ‚îÄ */
  .app {
    position: relative;
    z-index: 1;
    display: grid;
    grid-template-columns: 380px 1fr;
    grid-template-rows: 1fr auto;
    min-height: 100vh;
  }

  /* ‚îÄ‚îÄ‚îÄ LEFT PANE ‚îÄ‚îÄ‚îÄ */
  .left-pane {
    grid-row: 1 / 3;
    background: var(--surface);
    border-right: 1px solid var(--border);
    padding: 28px 22px;
    display: flex;
    flex-direction: column;
    gap: 22px;
    overflow-y: auto;
    min-height: 100vh;
  }

  /* Brand */
  .brand-tag {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 10px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 4px;
  }
  .brand-tag::before {
    content: '';
    width: 5px; height: 5px;
    border-radius: 50%;
    background: var(--accent);
    animation: blink 2s ease-in-out infinite;
  }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.3} }

  h1 {
    font-family: 'Syne', sans-serif;
    font-size: 23px;
    font-weight: 800;
    line-height: 1.15;
    letter-spacing: -.5px;
    margin-bottom: 6px;
  }
  h1 span {
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .brand-desc { font-size: 11px; color: var(--muted); line-height: 1.6; }

  /* Drop Zone */
  .drop-zone {
    border: 1.5px dashed var(--border);
    border-radius: 10px;
    background: var(--surface2);
    padding: 14px 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    transition: all .25s ease;
  }
  .drop-zone:hover, .drop-zone.drag-over {
    border-color: var(--accent);
    background: rgba(124,92,252,.07);
  }
  .drop-icon { font-size: 20px; flex-shrink: 0; transition: transform .2s; }
  .drop-zone:hover .drop-icon { transform: scale(1.15) rotate(-5deg); }
  .drop-text { flex: 1; min-width: 0; }
  .drop-text strong { font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700; display: block; }
  .drop-text small { font-size: 10px; color: var(--muted); }

  .browse-btn {
    flex-shrink: 0;
    background: linear-gradient(135deg, var(--accent), #5a3fd4);
    color: white; border: none; border-radius: 7px;
    padding: 7px 13px;
    font-family: 'DM Mono', monospace; font-size: 11px;
    cursor: pointer; transition: all .2s; white-space: nowrap;
  }
  .browse-btn:hover { box-shadow: 0 4px 16px rgba(124,92,252,.4); }
  #fileInput { display: none; }

  /* Section label */
  .sec-label {
    font-size: 10px; letter-spacing: 2px; text-transform: uppercase;
    color: var(--muted); margin-bottom: 8px;
  }

  /* File queue */
  .file-queue { display: flex; flex-direction: column; gap: 7px; }

  .file-item {
    display: flex; align-items: center; gap: 10px;
    background: var(--bg); border: 1px solid var(--border);
    border-radius: 8px; padding: 9px 12px;
    position: relative; overflow: hidden;
    animation: slideIn .25s ease;
  }
  .file-item::before {
    content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 2px;
    background: linear-gradient(to bottom, var(--accent), var(--accent2));
  }
  @keyframes slideIn { from{opacity:0;transform:translateY(-6px)} to{opacity:1;transform:translateY(0)} }

  .fi-info { flex: 1; min-width: 0; }
  .fi-name { font-size: 11px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .fi-meta { font-size: 10px; color: var(--muted); margin-top: 2px; }
  .fi-time { font-size: 9px; color: var(--muted); opacity: .7; margin-top: 1px; }

  .fi-badge {
    font-size: 10px; padding: 2px 8px; border-radius: 100px; flex-shrink: 0;
    background: rgba(124,92,252,.15); color: var(--accent);
  }
  .fi-badge.done { background: rgba(0,229,200,.15); color: var(--accent2); }

  .fi-remove {
    background: none; border: none; color: var(--muted);
    cursor: pointer; font-size: 13px; padding: 2px 4px;
    border-radius: 4px; transition: color .2s; flex-shrink: 0;
  }
  .fi-remove:hover { color: var(--error); }

  .empty-state {
    text-align: center; padding: 16px; color: var(--muted); font-size: 11px;
    border: 1px dashed var(--border); border-radius: 8px;
  }

  /* Action buttons */
  .actions { display: flex; gap: 8px; }

  .convert-btn {
    flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px;
    background: linear-gradient(135deg, var(--accent), #5a3fd4);
    color: white; border: none; border-radius: 8px;
    padding: 11px; font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700;
    cursor: pointer; transition: all .2s;
  }
  .convert-btn:hover:not(:disabled) { box-shadow: 0 8px 24px rgba(124,92,252,.4); transform: translateY(-1px); }
  .convert-btn:disabled { opacity: .35; cursor: not-allowed; }

  .clear-btn {
    background: var(--surface2); color: var(--muted);
    border: 1px solid var(--border); border-radius: 8px;
    padding: 11px 14px; font-family: 'DM Mono', monospace; font-size: 12px;
    cursor: pointer; transition: all .2s;
  }
  .clear-btn:hover { border-color: var(--error); color: var(--error); }

  /* Downloads */
  .downloads { display: flex; flex-direction: column; gap: 7px; }

  .dl-item {
    display: flex; align-items: center; gap: 10px;
    background: rgba(0,229,200,.06); border: 1px solid rgba(0,229,200,.2);
    border-radius: 8px; padding: 10px 12px;
    animation: slideIn .3s ease;
  }
  .dl-name { flex: 1; font-size: 11px; font-family: 'Syne', sans-serif; font-weight: 600; }
  .dl-name small { display: block; font-family: 'DM Mono', monospace; font-weight: 400; color: var(--muted); font-size: 10px; margin-top: 1px; }

  .view-btn {
    background: var(--surface2); color: var(--accent);
    border: 1px solid rgba(124,92,252,.3); border-radius: 6px;
    padding: 5px 10px; font-family: 'DM Mono', monospace; font-size: 10px;
    cursor: pointer; transition: all .2s; white-space: nowrap;
  }
  .view-btn:hover { background: rgba(124,92,252,.15); }

  .dl-btn {
    display: flex; align-items: center; gap: 5px;
    background: var(--accent2); color: #0a0a0f;
    border: none; border-radius: 6px; padding: 5px 11px;
    font-family: 'DM Mono', monospace; font-size: 10px; font-weight: 500;
    cursor: pointer; text-decoration: none; transition: all .2s; white-space: nowrap;
  }
  .dl-btn:hover { box-shadow: 0 4px 12px rgba(0,229,200,.4); }

  /* ‚îÄ‚îÄ‚îÄ RIGHT PANE ‚îÄ‚îÄ‚îÄ */
  .right-pane {
    padding: 28px 24px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .pane-title {
    font-family: 'Syne', sans-serif; font-size: 11px; font-weight: 700;
    color: var(--muted); text-transform: uppercase; letter-spacing: 2px;
    margin-bottom: 12px;
  }

  /* Overview cards */
  .overview-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
  }

  .ov-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; padding: 14px 14px;
    animation: fadeUp .4s ease;
    position: relative; overflow: hidden;
  }
  .ov-card::after {
    content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 2px;
    background: linear-gradient(90deg, var(--accent), var(--accent2)); opacity: .4;
  }
  @keyframes fadeUp { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

  .ov-label { font-size: 9px; color: var(--muted); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 6px; }
  .ov-value { font-family: 'Syne', sans-serif; font-size: 15px; font-weight: 700; color: var(--text); line-height: 1.2; }
  .ov-value.accent { color: var(--accent); }
  .ov-value.teal { color: var(--accent2); }

  /* Files list in right pane */
  .files-meta-list { display: flex; flex-direction: column; gap: 6px; }
  .fml-row {
    display: flex; align-items: center; gap: 10px;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 8px; padding: 10px 14px;
    animation: fadeUp .3s ease;
  }
  .fml-icon { font-size: 16px; flex-shrink: 0; }
  .fml-info { flex: 1; min-width: 0; }
  .fml-name { font-size: 11px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .fml-sub { font-size: 10px; color: var(--muted); margin-top: 2px; }
  .fml-time { font-size: 10px; color: var(--muted); flex-shrink: 0; text-align: right; }
  .fml-time span { display: block; font-size: 9px; opacity: .7; }

  /* Error breakdown table */
  .err-table-wrap { overflow-x: auto; }

  .err-table {
    width: 100%; border-collapse: collapse; font-size: 11px;
  }
  .err-table thead th {
    background: var(--surface2); color: var(--muted);
    font-size: 9px; letter-spacing: 1.5px; text-transform: uppercase;
    padding: 9px 12px; text-align: left; border-bottom: 1px solid var(--border);
    font-weight: 500; white-space: nowrap;
  }
  .err-table thead th.num { text-align: right; }
  .err-table tbody tr {
    border-bottom: 1px solid rgba(255,255,255,.04);
    transition: background .15s; animation: fadeUp .3s ease;
  }
  .err-table tbody tr:hover { background: rgba(124,92,252,.05); }
  .err-table tbody td { padding: 10px 12px; vertical-align: middle; }
  .err-table tbody td.num { text-align: right; font-family: 'DM Mono', monospace; }

  .err-code-badge {
    display: inline-block;
    font-family: 'DM Mono', monospace; font-size: 9px;
    background: rgba(255,95,109,.15); color: var(--error);
    border: 1px solid rgba(255,95,109,.25); padding: 2px 8px;
    border-radius: 100px; white-space: nowrap;
  }
  .rate-chip {
    display: inline-block; font-size: 10px;
    background: rgba(124,92,252,.15); color: var(--accent);
    border-radius: 4px; padding: 2px 6px;
  }
  .err-msg-cell { font-size: 10px; color: var(--text); max-width: 220px; }

  /* Placeholder */
  .placeholder {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    padding: 60px 20px; text-align: center; color: var(--muted); gap: 12px; flex: 1;
  }
  .placeholder-icon { font-size: 40px; opacity: .4; }
  .placeholder p { font-size: 12px; line-height: 1.6; max-width: 240px; }

  /* ‚îÄ‚îÄ‚îÄ TABLE PANE (full width bottom) ‚îÄ‚îÄ‚îÄ */
  .table-pane {
    grid-column: 1 / -1;
    border-top: 1px solid var(--border);
    background: var(--surface);
    display: none;
  }
  .table-pane.visible { display: block; }

  .table-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 14px 24px; border-bottom: 1px solid var(--border);
  }
  .table-title { font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 700; }
  .table-controls { display: flex; gap: 8px; align-items: center; }

  .search-box {
    background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
    padding: 6px 12px; font-family: 'DM Mono', monospace; font-size: 11px;
    color: var(--text); width: 200px; outline: none; transition: border-color .2s;
  }
  .search-box:focus { border-color: var(--accent); }
  .search-box::placeholder { color: var(--muted); }

  .close-tbl-btn {
    background: none; border: 1px solid var(--border); color: var(--muted);
    border-radius: 6px; padding: 6px 11px; font-size: 11px; cursor: pointer;
    font-family: 'DM Mono', monospace; transition: all .2s;
  }
  .close-tbl-btn:hover { border-color: var(--error); color: var(--error); }

  .tbl-wrap { overflow-x: auto; max-height: 380px; overflow-y: auto; }

  table.inv-table { width: 100%; border-collapse: collapse; font-size: 11px; white-space: nowrap; }
  table.inv-table thead th {
    position: sticky; top: 0; z-index: 2;
    background: #0d0d18; color: var(--muted); font-size: 9px;
    letter-spacing: 1.5px; text-transform: uppercase;
    padding: 9px 12px; text-align: left; border-bottom: 1px solid var(--border); font-weight: 500;
  }
  table.inv-table thead th.r { text-align: right; }
  table.inv-table tbody tr { border-bottom: 1px solid rgba(255,255,255,.03); transition: background .15s; }
  table.inv-table tbody tr:hover { background: rgba(124,92,252,.05); }
  table.inv-table tbody td { padding: 8px 12px; vertical-align: middle; }
  table.inv-table tbody td.r { text-align: right; font-family: 'DM Mono', monospace; }

  .t-gstin { font-family: 'DM Mono', monospace; color: var(--accent); font-size: 10px; }
  .t-inv { font-weight: 500; }
  .t-rate { display: inline-flex; align-items: center; justify-content: center; background: rgba(124,92,252,.15); color: var(--accent); border-radius: 4px; padding: 2px 6px; font-size: 10px; }
  .t-err { font-size: 9px; background: rgba(255,95,109,.12); color: var(--error); border-radius: 4px; padding: 2px 7px; border: 1px solid rgba(255,95,109,.2); }

  .tbl-footer {
    padding: 10px 24px; font-size: 11px; color: var(--muted);
    border-top: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
  }
  .tbl-footer .totals { color: var(--accent2); font-weight: 500; }

  .dl-consolidated {
    background: rgba(124,92,252,.08);
    border: 1px solid rgba(124,92,252,.3);
  }

  ::-webkit-scrollbar { width: 4px; height: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  @media (max-width: 860px) {
    .app { grid-template-columns: 1fr; }
    .left-pane { grid-row: auto; min-height: unset; border-right: none; border-bottom: 1px solid var(--border); }
    .overview-grid { grid-template-columns: repeat(2,1fr); }
    .table-pane { grid-column: 1; }
  }
</style>
</head>
<body>
<div class="app">

  <!-- ‚ïê‚ïê‚ïê LEFT PANE ‚ïê‚ïê‚ïê -->
  <div class="left-pane">

    <div>
      <div class="brand-tag">GSTR-1 ¬∑ Error Report Tool</div>
      <h1>JSON ‚Üí <span>Excel</span> Converter</h1>
      <p class="brand-desc">Convert GST GSTR-1 error report JSON files into structured Excel spreadsheets. Supports batch processing.</p>
    </div>

    <!-- Drop Zone -->
    <div>
      <div class="drop-zone" id="dropZone">
        <div class="drop-icon">üìÇ</div>
        <div class="drop-text">
          <strong>Drop JSON files here</strong>
          <small>GST error report ¬∑ Multiple files</small>
        </div>
        <button class="browse-btn" onclick="event.stopPropagation(); document.getElementById('fileInput').click()">‚¨Ü Browse</button>
      </div>
      <input type="file" id="fileInput" accept=".json" multiple>
    </div>

    <!-- Actions -->
    <div class="actions">
      <button class="convert-btn" id="convertBtn" onclick="convertAll()" disabled>‚ö° Convert to Excel</button>
      <button class="clear-btn" onclick="clearAll()">‚úï Clear</button>
    </div>

    <!-- File Queue -->
    <div>
      <div class="sec-label">Loaded Files</div>
      <div class="file-queue" id="fileQueue">
        <div class="empty-state">No files loaded yet</div>
      </div>
    </div>

  </div>

  <!-- ‚ïê‚ïê‚ïê RIGHT PANE ‚ïê‚ïê‚ïê -->
  <div class="right-pane" id="rightPane">
    <div class="placeholder">
      <div class="placeholder-icon">üìä</div>
      <p>Load JSON files on the left to see filing overview, error breakdown, and GSTIN analysis here.</p>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê INVOICE TABLE (full-width bottom) ‚ïê‚ïê‚ïê -->
  <div class="table-pane" id="tablePane">
    <div class="table-header">
      <div class="table-title">üìã Invoice Detail View</div>
      <div class="table-controls">
        <input type="text" class="search-box" id="searchBox" placeholder="Search GSTIN, invoice, error‚Ä¶" oninput="filterTable()">
        <button class="close-tbl-btn" onclick="closeTable()">‚úï Close</button>
      </div>
    </div>
    <div class="tbl-wrap">
      <table class="inv-table">
        <thead><tr>
          <th>#</th>
          <th>Receiver GSTIN</th>
          <th>Invoice No.</th>
          <th>Date</th>
          <th>Rate %</th>
          <th class="r">Taxable Value ‚Çπ</th>
          <th class="r">CGST ‚Çπ</th>
          <th class="r">SGST ‚Çπ</th>
          <th class="r">IGST ‚Çπ</th>
          <th class="r">Cess ‚Çπ</th>
          <th class="r">Invoice Total ‚Çπ</th>
          <th>Error Code</th>
        </tr></thead>
        <tbody id="invoiceBody"></tbody>
      </table>
    </div>
    <div class="tbl-footer" id="tblFooter"></div>
  </div>

</div>

<script>
// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const files = new Map(); // name -> { parsed, uploadedAt }
let allRows  = [];       // flat invoice rows for table view

// ‚îÄ‚îÄ‚îÄ Drop / Upload ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const dropZone  = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');

dropZone.addEventListener('dragover',  e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
dropZone.addEventListener('dragleave', ()  => dropZone.classList.remove('drag-over'));
dropZone.addEventListener('drop',      e  => { e.preventDefault(); dropZone.classList.remove('drag-over'); handleFiles([...e.dataTransfer.files]); });
dropZone.addEventListener('click',     e  => { if (!e.target.classList.contains('browse-btn')) fileInput.click(); });
fileInput.addEventListener('change',   e  => { handleFiles([...e.target.files]); fileInput.value = ''; });

function handleFiles(newFiles) {
  newFiles.forEach(f => {
    if (!f.name.endsWith('.json')) return;
    const reader = new FileReader();
    reader.onload = ev => {
      try {
        const parsed = JSON.parse(ev.target.result);
        files.set(f.name, { parsed, uploadedAt: new Date() });
        renderAll();
      } catch(err) { alert('Parse error in ' + f.name + ': ' + err.message); }
    };
    reader.readAsText(f);
  });
}

function removeFile(name) { files.delete(name); renderAll(); }

function clearAll() {
  files.clear();
  document.getElementById('rightDownloads').innerHTML = '';
  document.getElementById('rightDownloadsWrap').style.display = 'none';
  allRows = [];
  closeTable();
  renderAll();
}

function renderAll() {
  renderQueue();
  renderMetrics();
  document.getElementById('convertBtn').disabled = files.size === 0;
}

// ‚îÄ‚îÄ‚îÄ Left pane queue ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderQueue() {
  const q = document.getElementById('fileQueue');
  if (files.size === 0) { q.innerHTML = '<div class="empty-state">No files loaded yet</div>'; return; }
  q.innerHTML = '';
  files.forEach((data, name) => {
    const b2b      = data.parsed?.error_report?.b2b || [];
    const invCount = b2b.reduce((a, c) => a + (c.inv?.length || 0), 0);
    const fp       = data.parsed?.fp || '‚Äî';
    const div = document.createElement('div');
    div.className = 'file-item';
    div.id = 'fi_' + sanitize(name);
    div.innerHTML = `
      <div class="fi-info">
        <div class="fi-name">${name}</div>
        <div class="fi-meta">FP: ${fpFmt(fp)} ¬∑ ${b2b.length} receivers ¬∑ ${invCount} invoices</div>
        <div class="fi-time">Uploaded ${tsShort(data.uploadedAt)}</div>
      </div>
      <span class="fi-badge" id="badge_${sanitize(name)}">Ready</span>
      <button class="fi-remove" onclick="removeFile('${name}')">‚úï</button>`;
    q.appendChild(div);
  });
}

// ‚îÄ‚îÄ‚îÄ Right pane metrics ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderMetrics() {
  const rp = document.getElementById('rightPane');
  if (files.size === 0) {
    rp.innerHTML = `<div class="placeholder"><div class="placeholder-icon">üìä</div><p>Load JSON files on the left to see filing overview, error breakdown, and GSTIN analysis here.</p></div>`;
    return;
  }

  // ‚îÄ‚îÄ Aggregate ‚îÄ‚îÄ
  const gstins    = new Set();
  const periods   = new Set();
  const formTypes = new Set();
  const errorMap  = {}; // error_cd -> { msg, gstins:Set, invoices, byRate:{ rt -> {txval,camt,samt,igst} } }

  files.forEach(({ parsed }) => {
    const b2b = parsed?.error_report?.b2b || [];
    if (parsed.gstin)    gstins.add(parsed.gstin);
    if (parsed.fp)       periods.add(fpFmt(parsed.fp));
    if (parsed.form_typ) formTypes.add(parsed.form_typ);

    b2b.forEach(entry => {
      const cd = entry.error_cd;
      if (!errorMap[cd]) errorMap[cd] = { msg: entry.error_msg, gstins: new Set(), invoices: 0, byRate: {} };
      const eg = errorMap[cd];
      eg.gstins.add(entry.ctin);

      (entry.inv || []).forEach(inv => {
        eg.invoices++;
        (inv.itms || []).forEach(itm => {
          const d  = itm.itm_det || {};
          const rt = d.rt;
          if (!eg.byRate[rt]) eg.byRate[rt] = { txval: 0, camt: 0, samt: 0, igst: 0 };
          eg.byRate[rt].txval += d.txval  || 0;
          eg.byRate[rt].camt  += d.camt   || 0;
          eg.byRate[rt].samt  += d.samt   || 0;
          eg.byRate[rt].igst  += d.igst   || 0;
        });
      });
    });
  });

  // ‚îÄ‚îÄ Files metadata rows ‚îÄ‚îÄ
  const fileRows = [...files.entries()].map(([name, data]) => {
    const b2b = data.parsed?.error_report?.b2b || [];
    const inv = b2b.reduce((a, c) => a + (c.inv?.length || 0), 0);
    return `
      <div class="fml-row">
        <div class="fml-icon">üìÑ</div>
        <div class="fml-info">
          <div class="fml-name">${name}</div>
          <div class="fml-sub">FP: ${fpFmt(data.parsed?.fp)} ¬∑ ${b2b.length} receivers ¬∑ ${inv} invoices</div>
        </div>
        <div class="fml-time">${tsDate(data.uploadedAt)}<span>${tsTime(data.uploadedAt)}</span></div>
      </div>`;
  }).join('');

  // ‚îÄ‚îÄ Error breakdown table rows ‚îÄ‚îÄ
  // Each error_cd can span multiple rate rows
  const errRows = Object.entries(errorMap).map(([cd, eg]) => {
    const rates = Object.entries(eg.byRate).sort((a, b) => a[0] - b[0]);
    const rowSpan = rates.length || 1;

    return rates.map(([ rt, t ], i) => `
      <tr>
        ${i === 0 ? `<td rowspan="${rowSpan}"><span class="err-code-badge">${cd}</span></td>` : ''}
        ${i === 0 ? `<td rowspan="${rowSpan}" class="err-msg-cell">${eg.msg}</td>` : ''}
        ${i === 0 ? `<td rowspan="${rowSpan}" class="num">${eg.gstins.size}</td>` : ''}
        ${i === 0 ? `<td rowspan="${rowSpan}" class="num">${eg.invoices}</td>` : ''}
        <td><span class="rate-chip">${rt}%</span></td>
        <td class="num">${fmtNum(t.txval)}</td>
        <td class="num">${fmtNum(t.igst)}</td>
        <td class="num">${fmtNum(t.camt)}</td>
        <td class="num">${fmtNum(t.samt)}</td>
      </tr>`).join('');
  }).join('');

  rp.innerHTML = `
    <!-- SECTION 1: Overview -->
    <div>
      <div class="pane-title">Filing Overview</div>
      <div class="overview-grid">
        <div class="ov-card">
          <div class="ov-label">Supplier GSTIN</div>
          <div class="ov-value accent">${[...gstins].join(', ') || '‚Äî'}</div>
        </div>
        <div class="ov-card">
          <div class="ov-label">Filing Period</div>
          <div class="ov-value">${[...periods].join(', ') || '‚Äî'}</div>
        </div>
        <div class="ov-card">
          <div class="ov-label">Form Type</div>
          <div class="ov-value teal">${[...formTypes].join(', ') || '‚Äî'}</div>
        </div>
      </div>
    </div>

    <!-- SECTION 2: Error Code Breakdown -->
    <div>
      <div class="pane-title">Error Code Breakdown</div>
      <div class="err-table-wrap">
        <table class="err-table">
          <thead>
            <tr>
              <th>Error Code</th>
              <th>Error Message</th>
              <th class="num">GSTINs</th>
              <th class="num">Invoices</th>
              <th>GST Rate</th>
              <th class="num">Taxable Value ‚Çπ</th>
              <th class="num">IGST ‚Çπ</th>
              <th class="num">CGST ‚Çπ</th>
              <th class="num">SGST ‚Çπ</th>
            </tr>
          </thead>
          <tbody>${errRows}</tbody>
        </table>
      </div>
    </div>

    <!-- SECTION 3: Downloads (populated by convertAll) -->
    <div id="rightDownloadsWrap" style="display:none">
      <div class="pane-title">Downloads</div>
      <div class="downloads" id="rightDownloads"></div>
    </div>
  `;
}

// ‚îÄ‚îÄ‚îÄ Convert ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function convertAll() {
  if (files.size === 0) return;
  allRows = [];
  document.getElementById('rightDownloads').innerHTML = '';

  const allParsed = [];

  // First build consolidated (shown at top), then individual files below
  // We need to collect all rows first, so do a two-pass approach
  files.forEach((data, name) => {
    try {
      collectRows(data.parsed);
      allParsed.push(data.parsed);
    } catch(err) { console.error(err); }
  });

  // Consolidated card FIRST with View button
  try {
    const cwb   = buildConsolidatedWorkbook(allParsed);
    const carr  = XLSX.write(cwb, { bookType: 'xlsx', type: 'array' });
    const cblob = new Blob([carr], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    const curl  = URL.createObjectURL(cblob);
    addDownload('Consolidated_ErrorReport.xlsx', curl, null, true);
  } catch(err) { console.error('Consolidated error:', err); }

  // Individual file cards below ‚Äî no View button
  files.forEach((data, name) => {
    try {
      const wb      = buildWorkbook(data.parsed);
      const outName = name.replace('.json', '.xlsx');
      const arr     = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
      const blob    = new Blob([arr], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      const url     = URL.createObjectURL(blob);
      addDownload(outName, url, data.parsed, false);
      const badge = document.getElementById('badge_' + sanitize(name));
      if (badge) { badge.textContent = 'Done'; badge.classList.add('done'); }
    } catch(err) { alert('Error converting ' + name + ': ' + err.message); }
  });

  document.getElementById('rightDownloadsWrap').style.display = 'block';
}

function collectRows(parsed) {
  const b2b = parsed?.error_report?.b2b || [];
  b2b.forEach(entry => {
    (entry.inv || []).forEach(inv => {
      (inv.itms || []).forEach(itm => {
        const d = itm.itm_det || {};
        allRows.push({
          ctin: entry.ctin, inum: inv.inum, idt: inv.idt,
          rt: d.rt,
          txval: r2(d.txval), camt: r2(d.camt), samt: r2(d.samt),
          igst: r2(d.igst || 0), csamt: r2(d.csamt || 0),
          val: r2(inv.val), error_cd: entry.error_cd
        });
      });
    });
  });
}

function addDownload(name, url, parsed, isConsolidated) {
  const dl  = document.getElementById('rightDownloads');
  const div = document.createElement('div');
  div.className = 'dl-item' + (isConsolidated ? ' dl-consolidated' : '');

  let meta = '';
  if (isConsolidated) {
    meta = `${files.size} file${files.size !== 1 ? 's' : ''} ¬∑ ${allRows.length} line items ¬∑ All periods`;
  } else {
    const b2b  = parsed?.error_report?.b2b || [];
    const invC = b2b.reduce((a, c) => a + (c.inv?.length || 0), 0);
    meta = `${invC} invoices ¬∑ FP ${fpFmt(parsed.fp)}`;
  }

  const viewBtn = isConsolidated
    ? `<button class="view-btn" onclick="openTable()">üëÅ View</button>`
    : '';

  div.innerHTML = `
    <span style="font-size:18px">${isConsolidated ? 'üì¶' : 'üìä'}</span>
    <div class="dl-name">${name}<small>${meta}</small></div>
    ${viewBtn}
    <a class="dl-btn" href="${url}" download="${name}">‚¨á Download</a>`;
  dl.appendChild(div);
}

// ‚îÄ‚îÄ‚îÄ Consolidated Workbook ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildConsolidatedWorkbook(allParsed) {
  const wb = XLSX.utils.book_new();

  // Merge all b2b across files
  const allB2B   = [];
  const gstins   = new Set();
  const periods  = new Set();
  allParsed.forEach(p => {
    if (p.gstin) gstins.add(p.gstin);
    if (p.fp)    periods.add(fpFmt(p.fp));
    (p.error_report?.b2b || []).forEach(e => allB2B.push(e));
  });

  // Sheet 1 ‚Äì Consolidated Summary
  const sumRows = [
    ['Consolidated GST Error Report'], [],
    ['Supplier GSTIN(s)', [...gstins].join(', ')],
    ['Filing Period(s)',  [...periods].join(', ')],
    ['Total Files',       allParsed.length],
    [],
    ['Error Code Breakdown'],
    ['Error Code','Error Message','GSTINs','Invoices','GST Rate (%)','Taxable Value','IGST','CGST','SGST'],
  ];

  const eg = {};
  allB2B.forEach(e => {
    const cd = e.error_cd;
    if (!eg[cd]) eg[cd] = { msg: e.error_msg, gstins: new Set(), invoices: 0, byRate: {} };
    eg[cd].gstins.add(e.ctin);
    (e.inv || []).forEach(inv => {
      eg[cd].invoices++;
      (inv.itms || []).forEach(itm => {
        const d  = itm.itm_det || {};
        const rt = d.rt;
        if (!eg[cd].byRate[rt]) eg[cd].byRate[rt] = { txval:0, camt:0, samt:0, igst:0 };
        eg[cd].byRate[rt].txval += d.txval || 0;
        eg[cd].byRate[rt].camt  += d.camt  || 0;
        eg[cd].byRate[rt].samt  += d.samt  || 0;
        eg[cd].byRate[rt].igst  += d.igst  || 0;
      });
    });
  });

  Object.entries(eg).forEach(([cd, g]) => {
    Object.entries(g.byRate).forEach(([rt, t], i) => {
      sumRows.push([
        i === 0 ? cd : '', i === 0 ? g.msg : '',
        i === 0 ? g.gstins.size : '', i === 0 ? g.invoices : '',
        rt + '%', r2(t.txval), r2(t.igst), r2(t.camt), r2(t.samt)
      ]);
    });
  });

  const ws1 = XLSX.utils.aoa_to_sheet(sumRows);
  ws1['!cols'] = [16,38,10,10,12,18,14,14,14].map(w => ({ wch: w }));
  XLSX.utils.book_append_sheet(wb, ws1, 'Summary');

  // Sheet 2 ‚Äì All Invoices
  const hdr = ['Sr','Receiver GSTIN','Invoice No.','Date','Inv Type','POS','Rev Chg','Invoice Value ‚Çπ','Rate %','Taxable Value ‚Çπ','CGST ‚Çπ','SGST ‚Çπ','IGST ‚Çπ','Cess ‚Çπ','Error Code','Error Message'];
  const invRows = [hdr]; let sr = 1;
  allB2B.forEach(e => {
    (e.inv || []).forEach(inv => {
      (inv.itms || []).forEach(itm => {
        const d = itm.itm_det || {};
        invRows.push([
          sr++, e.ctin, inv.inum, inv.idt, inv.inv_typ, inv.pos, inv.rchrg,
          r2(inv.val), d.rt, r2(d.txval), r2(d.camt), r2(d.samt),
          r2(d.igst || 0), r2(d.csamt || 0), e.error_cd, e.error_msg
        ]);
      });
    });
  });
  const ws2 = XLSX.utils.aoa_to_sheet(invRows);
  ws2['!cols'] = [6,20,16,12,8,8,8,16,8,16,12,12,12,10,14,36].map(w => ({ wch: w }));
  XLSX.utils.book_append_sheet(wb, ws2, 'All Invoices');

  // Sheet 3 ‚Äì GSTIN Wise
  const gs = {};
  allB2B.forEach(e => {
    if (!gs[e.ctin]) gs[e.ctin] = { n:0, v:0, t:0, c:0, s:0, ig:0 };
    (e.inv || []).forEach(inv => {
      gs[e.ctin].n++; gs[e.ctin].v += inv.val || 0;
      (inv.itms || []).forEach(itm => {
        const d = itm.itm_det || {};
        gs[e.ctin].t  += d.txval || 0;
        gs[e.ctin].c  += d.camt  || 0;
        gs[e.ctin].s  += d.samt  || 0;
        gs[e.ctin].ig += d.igst  || 0;
      });
    });
  });
  const gsRows = [['Receiver GSTIN','Invoices','Invoice Value ‚Çπ','Taxable Value ‚Çπ','CGST ‚Çπ','SGST ‚Çπ','IGST ‚Çπ','Total GST ‚Çπ']];
  Object.entries(gs)
    .sort((a, b) => b[1].t - a[1].t)
    .forEach(([ctin, g]) =>
      gsRows.push([ctin, g.n, r2(g.v), r2(g.t), r2(g.c), r2(g.s), r2(g.ig), r2(g.c+g.s+g.ig)]));
  const ws3 = XLSX.utils.aoa_to_sheet(gsRows);
  ws3['!cols'] = [22,10,18,18,14,14,14,14].map(w => ({ wch: w }));
  XLSX.utils.book_append_sheet(wb, ws3, 'GSTIN Wise');

  return wb;
}

// ‚îÄ‚îÄ‚îÄ Invoice Table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let filteredRows = [];

function openTable() {
  filteredRows = [...allRows];
  renderTable(filteredRows);
  const tp = document.getElementById('tablePane');
  tp.classList.add('visible');
  tp.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function closeTable() {
  document.getElementById('tablePane').classList.remove('visible');
  document.getElementById('searchBox').value = '';
}

function filterTable() {
  const q = document.getElementById('searchBox').value.toLowerCase();
  filteredRows = allRows.filter(row =>
    row.ctin.toLowerCase().includes(q) ||
    row.inum.toLowerCase().includes(q) ||
    row.error_cd.toLowerCase().includes(q)
  );
  renderTable(filteredRows);
}

function renderTable(rows) {
  document.getElementById('invoiceBody').innerHTML = rows.map((row, i) => `
    <tr>
      <td>${i + 1}</td>
      <td class="t-gstin">${row.ctin}</td>
      <td class="t-inv">${row.inum}</td>
      <td>${row.idt}</td>
      <td><span class="t-rate">${row.rt}%</span></td>
      <td class="r">${locFmt(row.txval)}</td>
      <td class="r">${locFmt(row.camt)}</td>
      <td class="r">${locFmt(row.samt)}</td>
      <td class="r">${locFmt(row.igst)}</td>
      <td class="r">${locFmt(row.csamt)}</td>
      <td class="r" style="font-weight:600">${locFmt(row.val)}</td>
      <td><span class="t-err">${row.error_cd}</span></td>
    </tr>`).join('');

  const totTxval = rows.reduce((a, r) => a + r.txval, 0);
  const totTax   = rows.reduce((a, r) => a + r.camt + r.samt + r.igst, 0);
  const totVal   = rows.reduce((a, r) => a + r.val, 0);

  document.getElementById('tblFooter').innerHTML = `
    <span>${rows.length} rows</span>
    <span class="totals">
      Taxable: ‚Çπ${locFmt(totTxval)} &nbsp;|&nbsp;
      Total GST: ‚Çπ${locFmt(totTax)} &nbsp;|&nbsp;
      Invoice Total: ‚Çπ${locFmt(totVal)}
    </span>`;
}

// ‚îÄ‚îÄ‚îÄ Excel Build ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildWorkbook(parsed) {
  const wb  = XLSX.utils.book_new();
  const b2b = parsed?.error_report?.b2b || [];
  const fp  = parsed?.fp || '';
  const gstin = parsed?.gstin || '';

  // Sheet 1 ‚Äì Summary
  const sumRows = [
    ['GST Error Report Summary'], [],
    ['Supplier GSTIN', gstin],
    ['Filing Period',  fpFmt(fp)],
    ['Form Type',      parsed.form_typ || ''],
    ['Action',         parsed.action   || ''],
    ['Status',         parsed.status_cd|| ''],
    [],
    ['Error Code Breakdown'],
    ['Error Code','Error Message','GSTINs','Invoices','GST Rate (%)','Taxable Value','IGST','CGST','SGST'],
  ];

  const eg = {};
  b2b.forEach(e => {
    const cd = e.error_cd;
    if (!eg[cd]) eg[cd] = { msg: e.error_msg, gstins: new Set(), invoices: 0, byRate: {} };
    eg[cd].gstins.add(e.ctin);
    (e.inv || []).forEach(inv => {
      eg[cd].invoices++;
      (inv.itms || []).forEach(itm => {
        const d = itm.itm_det || {};
        const rt = d.rt;
        if (!eg[cd].byRate[rt]) eg[cd].byRate[rt] = { txval:0, camt:0, samt:0, igst:0 };
        eg[cd].byRate[rt].txval += d.txval || 0;
        eg[cd].byRate[rt].camt  += d.camt  || 0;
        eg[cd].byRate[rt].samt  += d.samt  || 0;
        eg[cd].byRate[rt].igst  += d.igst  || 0;
      });
    });
  });

  Object.entries(eg).forEach(([cd, g]) => {
    Object.entries(g.byRate).forEach(([rt, t], i) => {
      sumRows.push([
        i === 0 ? cd : '',
        i === 0 ? g.msg : '',
        i === 0 ? g.gstins.size : '',
        i === 0 ? g.invoices : '',
        rt + '%',
        r2(t.txval), r2(t.igst), r2(t.camt), r2(t.samt)
      ]);
    });
  });

  const ws1 = XLSX.utils.aoa_to_sheet(sumRows);
  ws1['!cols'] = [16,38,10,10,12,18,14,14,14].map(w => ({ wch: w }));
  XLSX.utils.book_append_sheet(wb, ws1, 'Summary');

  // Sheet 2 ‚Äì Invoice Detail
  const hdr = ['Sr','Receiver GSTIN','Invoice No.','Date','Inv Type','POS','Rev Chg','Invoice Value ‚Çπ','Rate %','Taxable Value ‚Çπ','CGST ‚Çπ','SGST ‚Çπ','IGST ‚Çπ','Cess ‚Çπ','Error Code','Error Message'];
  const rows2 = [hdr]; let sr = 1;
  b2b.forEach(e => {
    (e.inv || []).forEach(inv => {
      (inv.itms || []).forEach(itm => {
        const d = itm.itm_det || {};
        rows2.push([
          sr++, e.ctin, inv.inum, inv.idt, inv.inv_typ, inv.pos, inv.rchrg,
          r2(inv.val), d.rt, r2(d.txval), r2(d.camt), r2(d.samt),
          r2(d.igst || 0), r2(d.csamt || 0), e.error_cd, e.error_msg
        ]);
      });
    });
  });
  const ws2 = XLSX.utils.aoa_to_sheet(rows2);
  ws2['!cols'] = [6,20,16,12,8,8,8,16,8,16,12,12,12,10,14,36].map(w => ({ wch: w }));
  XLSX.utils.book_append_sheet(wb, ws2, 'Invoice Detail');

  // Sheet 3 ‚Äì GSTIN Wise
  const gs = {};
  b2b.forEach(e => {
    if (!gs[e.ctin]) gs[e.ctin] = { n:0, v:0, t:0, c:0, s:0, ig:0 };
    (e.inv || []).forEach(inv => {
      gs[e.ctin].n++; gs[e.ctin].v += inv.val || 0;
      (inv.itms || []).forEach(itm => {
        const d = itm.itm_det || {};
        gs[e.ctin].t  += d.txval || 0;
        gs[e.ctin].c  += d.camt  || 0;
        gs[e.ctin].s  += d.samt  || 0;
        gs[e.ctin].ig += d.igst  || 0;
      });
    });
  });
  const ws3Rows = [['Receiver GSTIN','Invoices','Invoice Value ‚Çπ','Taxable Value ‚Çπ','CGST ‚Çπ','SGST ‚Çπ','IGST ‚Çπ','Total GST ‚Çπ']];
  Object.entries(gs).forEach(([ctin, g]) =>
    ws3Rows.push([ctin, g.n, r2(g.v), r2(g.t), r2(g.c), r2(g.s), r2(g.ig), r2(g.c+g.s+g.ig)]));
  const ws3 = XLSX.utils.aoa_to_sheet(ws3Rows);
  ws3['!cols'] = [22,10,18,18,14,14,14,14].map(w => ({ wch: w }));
  XLSX.utils.book_append_sheet(wb, ws3, 'GSTIN Wise');

  return wb;
}

// ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function r2(n)       { return Math.round((n || 0) * 100) / 100; }
function sanitize(s) { return s.replace(/[^a-z0-9]/gi, '_'); }
function fpFmt(fp)   { return fp && fp.length === 6 ? fp.slice(0,2) + '/' + fp.slice(2) : (fp || '‚Äî'); }

function fmtNum(n) {
  n = r2(n);
  if (n >= 10000000) return '‚Çπ' + (n/10000000).toFixed(2) + ' Cr';
  if (n >= 100000)   return '‚Çπ' + (n/100000).toFixed(2)   + ' L';
  if (n >= 1000)     return '‚Çπ' + (n/1000).toFixed(1)     + ' K';
  return '‚Çπ' + n.toLocaleString('en-IN', { minimumFractionDigits: 2 });
}

function locFmt(n) {
  return r2(n).toLocaleString('en-IN', { minimumFractionDigits: 2 });
}

function tsDate(d)  { return d.toLocaleDateString('en-IN', { day:'2-digit', month:'short', year:'numeric' }); }
function tsTime(d)  { return d.toLocaleTimeString('en-IN', { hour:'2-digit', minute:'2-digit', hour12: true }); }
function tsShort(d) { return tsDate(d) + ' ' + tsTime(d); }
</script>
</body>
</html>
